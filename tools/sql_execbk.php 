<?php
/**
 * SQL EXECUTOR ‚Äî Paso 1: Login  ‚Üí  Paso 2: Textarea con SQL
 * Ruta sugerida: /tools/sql_exec.php
 * ‚ö†Ô∏è √ösalo solo como admin (credenciales abajo). Mant√©n este archivo privado.
 */

require_once __DIR__ . '/../includes/db.php';
session_start();

/* ====== CONFIG ====== */
define('ADMIN_USER', 'mugarte');           // c√°mbialo
define('ADMIN_PASS', 'Marden7i/');  // c√°mbiala
/* ==================== */

if (isset($_GET['logout'])) {
  session_destroy();
  header('Location: sql_exec.php');
  exit;
}

$pdo = db();
$msg  = '';
$html = '';

/* ========== NO LOGUEADO: mostrar login y validar credenciales ========== */
if (empty($_SESSION['sql_exec_logged'])) {
  if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['do_login'])) {
    $u = trim($_POST['user'] ?? '');
    $p = trim($_POST['pass'] ?? '');
    if ($u === ADMIN_USER && $p === ADMIN_PASS) {
      $_SESSION['sql_exec_logged'] = true;
      header('Location: sql_exec.php'); // refresca a la vista de SQL
      exit;
    } else {
      $msg = '‚ùå Usuario o contrase√±a incorrectos.';
    }
  }
  ?>
  <!doctype html>
  <html lang="es">
  <head>
    <meta charset="utf-8">
    <title>SQL Executor ‚Äî Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body{font-family:sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;background:#f9fafb;margin:0}
      .card{background:#fff;padding:28px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.08);width:320px}
      h1{font-size:20px;margin:0 0 14px}
      input{width:100%;padding:10px;margin:6px 0 10px;border-radius:8px;border:1px solid #d1d5db}
      button{width:100%;background:#2563eb;color:#fff;padding:10px;border:none;border-radius:8px;cursor:pointer}
      button:hover{background:#1d4ed8}
      .msg{margin-bottom:10px;padding:10px;border-radius:8px;background:#fef2f2;color:#991b1b;border-left:5px solid #dc2626}
      .hint{color:#6b7280;font-size:12px;margin-top:8px}
    </style>
  </head>
  <body>
    <form class="card" method="post">
      <h1>üîí SQL Executor</h1>
      <?php if($msg): ?><div class="msg"><?= htmlspecialchars($msg) ?></div><?php endif; ?>
      <input type="text" name="user" placeholder="Usuario" required>
      <input type="password" name="pass" placeholder="Contrase√±a" required>
      <button name="do_login" value="1">Entrar</button>
      <div class="hint">Acceso restringido</div>
    </form>
  </body>
  </html>
  <?php
  exit;
}

/* ========== LOGUEADO: mostrar textarea y ejecutar SQL ========== */
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['run_sql'])) {
  $sql = trim($_POST['sql'] ?? '');
  if ($sql === '') {
    $msg = '‚ö†Ô∏è Ingresa una consulta SQL.';
  } else {
    try {
      $start = microtime(true);
      // Si es SELECT queremos mostrar resultados, para otros (ALTER/UPDATE/INSERT/DELETE) basta con exec
      if (stripos($sql, 'select') === 0) {
        $stmt = $pdo->query($sql);
        $rows = $stmt ? $stmt->fetchAll(PDO::FETCH_ASSOC) : [];
        $elapsed = round((microtime(true) - $start) * 1000, 2);
        $msg = "‚úÖ SELECT ejecutado en {$elapsed} ms. Filas: <b>".count($rows)."</b>";
        if ($rows) {
          $cols = array_keys($rows[0]);
          $t  = "<div style='overflow:auto;margin-top:10px'><table border='1' cellpadding='6' cellspacing='0' style='border-collapse:collapse;min-width:600px'>";
          $t .= "<tr style='background:#f3f4f6'>";
          foreach ($cols as $c) $t .= "<th>".htmlspecialchars($c)."</th>";
          $t .= "</tr>";
          foreach ($rows as $r) {
            $t .= "<tr>";
            foreach ($cols as $c) $t .= "<td>".htmlspecialchars((string)$r[$c])."</td>";
            $t .= "</tr>";
          }
          $t .= "</table></div>";
          $html = $t;
        } else {
          $html = "<p style='margin-top:8px;color:#6b7280'><i>Sin resultados.</i></p>";
        }
      } else {
        $affected = $pdo->exec($sql);
        $elapsed  = round((microtime(true) - $start) * 1000, 2);
        $msg = "‚úÖ SQL ejecutado correctamente.<br>Filas afectadas: <b>".(int)$affected."</b><br>Tiempo: {$elapsed} ms";
      }
    } catch (Throwable $e) {
      $msg = "‚ùå <b>Error:</b> ".htmlspecialchars($e->getMessage());
    }
  }
}

// Valor retenido del textarea
$prev_sql = isset($_POST['sql']) ? (string)$_POST['sql'] : "ALTER TABLE products ADD COLUMN image2 TEXT;";
?>
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>SQL Executor ‚Äî Admin Tools</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body{font-family:sans-serif;background:#f9fafb;margin:0;padding:24px}
  .wrap{max-width:900px;margin:0 auto;background:#fff;padding:22px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
  h1{margin:0 0 10px}
  .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  .btn{background:#2563eb;color:#fff;padding:9px 14px;border:none;border-radius:8px;text-decoration:none}
  .btn:hover{background:#1d4ed8}
  textarea{width:100%;height:180px;font-family:monospace;padding:10px;border-radius:8px;border:1px solid #d1d5db}
  .run{margin-top:10px}
  .msg{margin-top:14px;padding:12px;border-radius:8px}
  .ok{background:#ecfdf5;color:#065f46;border-left:5px solid #16a34a}
  .err{background:#fef2f2;color:#991b1b;border-left:5px solid #dc2626}
  .hint{color:#6b7280;font-size:12px;margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>üõ†Ô∏è SQL Executor</h1>
      <a class="btn" href="?logout=1" style="background:#9ca3af">Salir</a>
    </div>

    <form method="post">
      <textarea name="sql" placeholder="Pega aqu√≠ tu SQL..."><?= htmlspecialchars($prev_sql) ?></textarea>
      <div class="run">
        <button class="btn">Ejecutar SQL</button>
        <input type="hidden" name="run_sql" value="1">
      </div>
    </form>

    <?php if($msg): ?>
      <div class="msg <?= (strpos($msg,'‚ùå')!==false?'err':'ok') ?>"><?= $msg ?></div>
      <?= $html ?>
    <?php endif; ?>

    <div class="hint">
      Ejemplo: <code>ALTER TABLE products ADD COLUMN image2 TEXT;</code><br>
      Si ejecutas un <b>SELECT</b>, se mostrar√° una tabla con los resultados.
    </div>
  </div>
</body>
</html>
